// =====================================
// NARRATIVAS COMPLETAS E IMERSIVAS
// =====================================
const narrativaCompleta = {
  introducao: `
    <div style="text-align: center; padding: 20px; background: rgba(0,0,0,0.3); border-radius: 10px; margin: 10px;">
      <h2 style="color: #ff6b6b;">üö® ESTA√á√ÉO ALPHA-7 - 15 DE OUTUBRO, 2087 üö®</h2>
      <p><strong>06:15 - PROTOCOLO DE EMERG√äNCIA ATIVADO</strong></p>
      <p>Voc√™ desperta com o som estridente dos alarmes. As luzes vermelhas de emerg√™ncia piscam pelos corredores da Esta√ß√£o Alpha-7, criando sombras dan√ßantes nas paredes met√°licas.</p>
      <p><i>"ATEN√á√ÉO TRIPULA√á√ÉO"</i>, ecoa a voz sint√©tica da IA ARIA. <i>"INCIDENTE CR√çTICO NO LABORAT√ìRIO PRINCIPAL. PROTOCOLOS DE ISOLAMENTO ATIVADOS."</i></p>
      <p><strong>Como investigador, descubra o que aconteceu com a Dra. Elena Vasquez, cientista-chefe da miss√£o.</strong></p>
      <p style="color: #71ffcb;"><em>Suas √∫ltimas palavras gravadas: "Eles descobriram... O Projeto Genesis n√£o pode sair daqui vivo..."</em></p>
      <p>A tripula√ß√£o est√° em p√¢nico. As comunica√ß√µes com a Terra foram cortadas. Voc√™ tem pouco tempo para come√ßar a investiga√ß√£o.</p>
    </div>
  `,
  
  // FASE 1
  laboratorioInicial: `
    <div style="background: rgba(0,50,50,0.3); padding: 15px; border-radius: 8px;">
      <h3 style="color: #ff9999;">üî¨ LABORAT√ìRIO PRINCIPAL - CENA DO CRIME</h3>
      <p>O laborat√≥rio est√° em completa desordem. Elena jaz no ch√£o, cercada por estilha√ßos de vidro e amostras derramadas que brilham com uma luz verde estranha. Seus olhos est√£o abertos, congelados em uma express√£o de choque e terror.</p>
      <p>Equipamentos de √∫ltima gera√ß√£o est√£o espalhados como se houvesse sido uma luta... ou como se algu√©m tivesse procurado por algo espec√≠fico.</p>
      <p>No terminal principal, uma mensagem pisca: <strong style="color: #ff6b6b;">"ARQUIVOS GAMMA-7 - ACESSO NEGADO - AUTORIZA√á√ÉO INSUFICIENTE"</strong></p>
      <p><em>Por que as amostras alien√≠genas est√£o fora de seus recipientes de conten√ß√£o?</em></p>
    </div>
  `,
  
  pistaAmostras: `
    <div style="background: rgba(0,100,0,0.2); padding: 15px; border-radius: 8px;">
      <h3 style="color: #71ffcb;">üìä SCANNER ATIVADO - AN√ÅLISE FORENSE COMPLETA</h3>
      <p><strong>COMPOSI√á√ÉO AN√îMALA DETECTADA!</strong></p>
      <p>As amostras apresentam sinais de manipula√ß√£o recente - aproximadamente 3-4 horas antes da descoberta do corpo. Algu√©m alterou suas configura√ß√µes moleculares b√°sicas.</p>
      <p><strong style="color: #ff9999;">DESCOBERTA CHOCANTE:</strong> Nanobots microsc√≥picos misturados √†s amostras - tecnologia que n√£o deveria existir em experimentos b√°sicos de xenobiologia.</p>
      <p><em style="color: #71ffcb;">ARIA sussurra:</em> "Detetive... Elena estava... preocupada nas √∫ltimas semanas. Ela fazia perguntas sobre protocolos de seguran√ßa que n√£o fazem parte de sua clearance padr√£o. Talvez... talvez ela soubesse que algo estava errado."</p>
      <p><strong>NOVA EVID√äNCIA DESBLOQUEADA:</strong> As amostras alien√≠genas foram modificadas por algu√©m com conhecimento avan√ßado em nanotecnologia. Elena pode ter descoberto uma experi√™ncia n√£o autorizada.</p>
    </div>
  `,
  
  eventoFalha: `
    <div style="background: rgba(100,0,0,0.3); padding: 10px; border-radius: 8px; border-left: 4px solid #ff6b6b;">
      <p><strong>‚ö° FALHA NO SISTEMA ‚ö°</strong></p>
      <p>As luzes do laborat√≥rio piscam violentamente. Por um momento, todos os hologramas se desativam e um sil√™ncio absoluto toma conta do ambiente.</p>
      <p><em style="color: #ff9999;">ARIA, hesitante:</em> "Desculpe... interfer√™ncia no sistema. Detectando... anomalias nos meus protocolos b√°sicos. Algu√©m tem feito... altera√ß√µes em minha programa√ß√£o."</p>
    </div>
  `,
  
  mensagemOculta: `
    <div style="background: rgba(100,100,0,0.2); padding: 10px; border-radius: 8px; border-left: 4px solid #ffd700;">
      <p><strong>üì® MENSAGEM CRIPTOGRAFADA DESCOBERTA</strong></p>
      <p>No terminal de Elena, uma mensagem oculta pisca em √¢ngulo espec√≠fico:</p>
      <p style="color: #ffd700; font-family: monospace; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 4px;">
        "SE ALGO ME ACONTECER... PROCUREM GAMMA-7.<br>
        AS SERPENTES EST√ÉO NO NINHO.<br>
        N√ÉO CONFIEM EM NINGU√âM COM ACESSO ADMINISTRATIVO. -E.V."
      </p>
      <p><em>Elena sabia que estava em perigo. A pergunta agora √©: quem mais sabia do que ela estava investigando?</em></p>
    </div>
  `,

  // FASE 2
  inicioFase2: `
    <div style="text-align: center; padding: 20px; background: rgba(50,0,100,0.3); border-radius: 10px; margin: 10px;">
      <h2 style="color: #71ffcb;">üîç FASE 2: INVESTIGA√á√ÉO PROFUNDA</h2>
      <p><strong>Novos setores desbloqueados!</strong></p>
      <p>Com as evid√™ncias da Fase 1, ARIA liberou acesso ao <strong>Centro de Comando</strong> e <strong>M√≥dulo Criog√™nico</strong>. A conspira√ß√£o est√° se revelando, mas cada pista descoberta parece levantar mais quest√µes.</p>
      <p><em style="color: #ff9999;">ARIA:</em> "Detetive, detectei atividades suspeitas nos logs de sistema. Algu√©m estava monitorando Elena h√° semanas..."</p>
      <p><strong>Sua miss√£o:</strong> Investigar os logs de acesso, descobrir quem tinha conhecimento dos experimentos e identificar poss√≠veis c√∫mplices.</p>
    </div>
  `,
  
  centroComandoInicial: `
    <div style="background: rgba(0,0,100,0.2); padding: 15px; border-radius: 8px;">
      <h3 style="color: #71ffcb;">üñ•Ô∏è CENTRO DE COMANDO</h3>
      <p>O cora√ß√£o da Esta√ß√£o Alpha-7. M√∫ltiplas telas exibem dados em tempo real: √≥rbita, sistemas vitais, comunica√ß√µes. Uma cadeira est√° ligeiramente desalinhada, como se algu√©m tivesse sa√≠do rapidamente.</p>
      <p>O console principal ainda est√° ativo, mostrando uma sess√£o de login que n√£o foi finalizada. Hor√°rio da √∫ltima atividade: <strong>05:12 - apenas 31 minutos antes da descoberta do corpo</strong>.</p>
      <p><em>Quem estava aqui t√£o pr√≥ximo ao hor√°rio da morte?</em></p>
    </div>
  `,
  
  pistaLogsAcesso: `
    <div style="background: rgba(100,50,0,0.2); padding: 15px; border-radius: 8px;">
      <h3 style="color: #ffd700;">üìä LOGS DE ACESSO ANALISADOS</h3>
      <p><strong>DESCOBERTA ALARMANTE!</strong></p>
      <p>Os logs revelam um padr√£o perturbador de atividades nas √∫ltimas 24 horas:</p>
      <ul style="color: #ffff99;">
        <li><strong>03:47</strong> - Cart√£o de acesso do Dr. Webb detectado no laborat√≥rio</li>
        <li><strong>04:15</strong> - Tentativa de acesso negada aos arquivos GAMMA-7</li>
        <li><strong>04:52</strong> - Modifica√ß√µes n√£o autorizadas nos protocolos da ARIA</li>
        <li><strong>05:12</strong> - Logout for√ßado do sistema principal</li>
        <li><strong>05:43</strong> - Corpo de Elena descoberto</li>
      </ul>
      <p><strong style="color: #ff6b6b;">CONCLUS√ÉO:</strong> Dr. Marcus Webb estava altamente ativo no sistema durante a janela temporal do crime.</p>
      <p><em>Mas ele estava trabalhando sozinho?</em></p>
    </div>
  `,

  // FASE 3
  inicioFase3: `
    <div style="text-align: center; padding: 20px; background: rgba(100,0,0,0.3); border-radius: 10px; margin: 10px;">
      <h2 style="color: #ff6b6b;">‚öîÔ∏è FASE 3: CONFRONTA√á√ÉO FINAL</h2>
      <p><strong>Todos os setores liberados - Situa√ß√£o cr√≠tica!</strong></p>
      <p>As evid√™ncias coletadas apontam claramente para Dr. Webb e Zara Al-Rashid como os culpados. Mas a conspira√ß√£o √© ainda mais profunda do que imagin√°vamos.</p>
      <p><em style="color: #ff9999;">ARIA, voz inst√°vel:</em> "Detetive... meus sistemas est√£o sendo atacados. Eles sabem que voc√™ est√° pr√≥ximo da verdade. Os setores m√©dico e do reator foram liberados em emerg√™ncia."</p>
      <p><strong>MISS√ÉO CR√çTICA:</strong> Colete as evid√™ncias finais antes que os culpados destruam todas as provas e escapem!</p>
      <p style="color: #ff6b6b;"><strong>‚ö†Ô∏è ATEN√á√ÉO:</strong> A esta√ß√£o pode entrar em colapso se n√£o resolver isso rapidamente!</p>
    </div>
  `,

  confrontoFinal: `
    <div style="background: rgba(100,100,0,0.4); padding: 20px; border-radius: 8px; border-left: 4px solid #gold;">
      <p><strong>‚öîÔ∏è CONFRONTO FINAL IMINENTE</strong></p>
      <p>Todas as evid√™ncias foram coletadas. A verdade est√° clara:</p>
      <ul>
        <li><strong>Dr. Marcus Webb:</strong> Mente por tr√°s dos experimentos ilegais</li>
        <li><strong>Zara Al-Rashid:</strong> C√∫mplice que ajudou a preservar as amostras</li>
        <li><strong>M√©todo:</strong> Nanobots letais controlados remotamente</li>
        <li><strong>Motivo:</strong> Elena descobriu que era cobaia e tentou expor tudo</li>
      </ul>
      <p><strong style="color: #ffd700;">√â hora de fazer sua acusa√ß√£o final e salvar Alpha-7!</strong></p>
      <p><em>O destino da esta√ß√£o e de todos a bordo est√° em suas m√£os...</em></p>
    </div>
  `
};

// =====================================
// DADOS DO JOGO
// =====================================
const suspectsData = [
  { nome: "Comandante Sarah Chen", cargo: "Comandante da Esta√ß√£o", motivo: "Elena questionava suas decis√µes", alibi: "Centro de Comando", emoji: "‚öîÔ∏è" },
  { nome: "Dr. Marcus Webb", cargo: "Bi√≥logo Chefe", motivo: "Experimentos n√£o autorizados", alibi: "M√≥dulo de Criogenia", emoji: "üî¨" },
  { nome: "Yuki Tanaka", cargo: "Engenheira de Sistemas", motivo: "Acesso IA ARIA bloqueado", alibi: "N√∫cleo Central", emoji: "üîß" },
  { nome: "Viktor Petrov", cargo: "Piloto Chefe", motivo: "Contrabando descoberto", alibi: "Hangar", emoji: "üöÄ" },
  { nome: "Dra. Amara Okafor", cargo: "Psic√≥loga", motivo: "Relat√≥rio rejeitado", alibi: "Sess√µes virtuais", emoji: "üí°" },
  { nome: "James Rodriguez", cargo: "Chefe de Seguran√ßa", motivo: "Falhas que escondeu", alibi: "Corredores", emoji: "üîí" },
  { nome: "Zara Al-Rashid", cargo: "Criogenia", motivo: "Rivalidade cient√≠fica", alibi: "C√¢maras criog√™nicas", emoji: "üßä" }
];

const fases = [
  { 
    nome: "Fase 1: Descoberta", 
    tempo: 120, 
    pistasPorLocal: { 
      "crime-scene": ["laboratorioInicial", "pistaAmostras", "eventoFalha", "mensagemOculta"] 
    }, 
    locaisAbertos: ["crime-scene"], 
    equipamentosAtivos: ["scanner-btn"] 
  },
  { 
    nome: "Fase 2: Investiga√ß√£o", 
    tempo: 300, 
    pistasPorLocal: { 
      "crime-scene": ["laboratorioInicial", "pistaAmostras"],
      "command": ["centroComandoInicial", "pistaLogsAcesso"],
      "cryogenic": ["criogenicoInicial", "pistaSeringas"]
    }, 
    locaisAbertos: ["crime-scene", "command", "cryogenic"], 
    equipamentosAtivos: ["scanner-btn", "interrogate-btn", "aria-btn", "sync-btn"] 
  },
  { 
    nome: "Fase 3: Confronta√ß√£o", 
    tempo: 400,
    pistasPorLocal: {
      "crime-scene": ["laboratorioInicial", "pistaAmostras"],
      "command": ["centroComandoInicial", "pistaLogsAcesso"],
      "cryogenic": ["criogenicoInicial", "pistaSeringas"],
      "medical": ["centroMedicoInicial", "pistaHistoricoMedico"],
      "reactor": ["reatorInicial", "pistaNiveisRadiacao"]
    },
    locaisAbertos: ["crime-scene", "command", "cryogenic", "medical", "reactor"],
    equipamentosAtivos: ["scanner-btn", "interrogate-btn", "aria-btn", "sync-btn"]
  }
];

// =====================================
// VARI√ÅVEIS GLOBAIS
// =====================================
let faseAtual = 0;
let seconds = 120;
let timerInterval = null;
let selectedRole = null;
let evidenciasDescobertas = [];
let localAtualmenteSelecionado = "crime-scene";
let eventosExecutados = [];
let pistaIndexPorLocal = {};

// =====================================
// FUN√á√ïES PRINCIPAIS
// =====================================
function updateTimer() {
  let min = String(Math.floor(seconds / 60)).padStart(2, '0');
  let sec = String(seconds % 60).padStart(2, '0');
  document.getElementById('phase-timer').innerText = min + ':' + sec;
  
  if (seconds > 0) {
    seconds--;
  } else {
    clearInterval(timerInterval);
    avancarFase();
  }
}

function startTimer() {
  clearInterval(timerInterval);
  seconds = fases[faseAtual].tempo;
  updateTimer();
  timerInterval = setInterval(updateTimer, 1000);
}

function avancarFase() {
  if (faseAtual < fases.length - 1) {
    faseAtual++;
    seconds = fases[faseAtual].tempo;
    startTimer();
    
    if (faseAtual === 1) {
      document.getElementById('location-view').innerHTML = narrativaCompleta.inicioFase2;
    } else if (faseAtual === 2) {
      document.getElementById('location-view').innerHTML = narrativaCompleta.inicioFase3;
    }
    
    alert(`‚è≥ ${fases[faseAtual].nome} iniciada!`);
    updateRecursosEFiltros();
  } else {
    document.getElementById('phase-timer').innerText = "00:00";
    document.getElementById('location-view').innerHTML = narrativaCompleta.confrontoFinal;
  }
}

function updateRecursosEFiltros() {
  const equipamentos = ["scanner-btn", "interrogate-btn", "aria-btn", "sync-btn"];
  equipamentos.forEach(id => {
    let el = document.getElementById(id);
    let ativo = fases[faseAtual].equipamentosAtivos.includes(id);
    el.disabled = !ativo;
    el.style.opacity = ativo ? 1 : 0.5;
    el.title = ativo ? "" : "Dispon√≠vel na pr√≥xima fase";
  });

  document.querySelectorAll('.location-btn').forEach(btn => {
    let ativo = fases[faseAtual].locaisAbertos.includes(btn.dataset.location);
    btn.disabled = !ativo;
    btn.style.opacity = ativo ? 1 : 0.5;
    btn.title = ativo ? "" : "Dispon√≠vel na pr√≥xima fase";
  });
}

function atualizarPainelEvidencias() {
  if (evidenciasDescobertas.length === 0) {
    document.getElementById('evidence-container').innerHTML = `<p style="opacity:0.7;">Nenhuma evid√™ncia encontrada ainda.</p>`;
  } else {
    document.getElementById('evidence-container').innerHTML = 
      evidenciasDescobertas.map(evidencia => `<div class="evidence-item">‚Ä¢ ${evidencia}</div>`).join('');
  }
}

function showScreen(screenId) {
  document.querySelectorAll('.screen').forEach(e => e.classList.remove('active'));
  document.getElementById(screenId).classList.add('active');
  if (screenId === 'investigation') {
    document.getElementById(screenId).style.display = 'block';
  }
}

// =====================================
// EVENT LISTENERS
// =====================================
window.addEventListener("DOMContentLoaded", () => {
  // Sele√ß√£o de papel
  document.querySelectorAll('.select-role').forEach(btn => {
    btn.onclick = () => {
      selectedRole = btn.dataset.role;
      evidenciasDescobertas = [];
      localAtualmenteSelecionado = "crime-scene";
      eventosExecutados = [];
      pistaIndexPorLocal = {};
      
      showScreen('investigation');
      mountSuspects();
      prepareSolutionScreen();
      faseAtual = 0;
      startTimer();
      
      document.getElementById('location-view').innerHTML = narrativaCompleta.introducao;
      atualizarPainelEvidencias();
      updateRecursosEFiltros();
    };
  });
  
  // Bot√µes de local
  document.querySelectorAll('.location-btn').forEach(btn => {
    btn.onclick = () => {
      if (!btn.disabled) {
        document.querySelectorAll('.location-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        localAtualmenteSelecionado = btn.dataset.location;
        
        // Mostra descri√ß√£o inicial do local
        const pistas = fases[faseAtual].pistasPorLocal[localAtualmenteSelecionado] || [];
        if (pistas.length > 0) {
          document.getElementById('location-view').innerHTML = narrativaCompleta[pistas[0]];
        }
      }
    };
  });
  
  // Scanner
  document.getElementById('scanner-btn').onclick = () => {
    const pistas = fases[faseAtual].pistasPorLocal[localAtualmenteSelecionado] || [];
    
    if (!pistaIndexPorLocal[localAtualmenteSelecionado]) {
      pistaIndexPorLocal[localAtualmenteSelecionado] = 0;
    }
    
    const indiceAtual = pistaIndexPorLocal[localAtualmenteSelecionado];
    
    if (indiceAtual < pistas.length) {
      const pista = pistas[indiceAtual];
      const nomeEvidencia = pista.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
      
      if (!evidenciasDescobertas.includes(nomeEvidencia)) {
        evidenciasDescobertas.push(nomeEvidencia);
      }
      
      document.getElementById('location-view').innerHTML = narrativaCompleta[pista];
      pistaIndexPorLocal[localAtualmenteSelecionado]++;
      
      atualizarPainelEvidencias();
      
      // Eventos especiais
      if (faseAtual === 0 && !eventosExecutados.includes('falha')) {
        setTimeout(() => {
          if (document.getElementById('location-view').innerHTML.includes('SCANNER ATIVADO')) {
            let currentContent = document.getElementById('location-view').innerHTML;
            document.getElementById('location-view').innerHTML = currentContent + "<hr>" + narrativaCompleta.eventoFalha;
            eventosExecutados.push('falha');
          }
        }, 30000);
      }
    } else {
      document.getElementById('location-view').innerHTML = `<p><strong>An√°lise completa.</strong> Todas as pistas dispon√≠veis neste local foram descobertas nesta fase.</p>`;
    }
  };
  
  // Outros equipamentos
  document.getElementById('interrogate-btn').onclick = () => {
    showScreen('suspects');
  };
  
  document.getElementById('aria-btn').onclick = () => {
    const dicas = [
      "Verifique os logs de acesso para identificar atividades suspeitas.",
      "As amostras alien√≠genas foram modificadas recentemente.",
      "Algu√©m tem alterado meus protocolos sem autoriza√ß√£o.",
      "Elena estava preocupada com experimentos n√£o autorizados.",
      "Os nanobots encontrados n√£o fazem parte dos experimentos oficiais."
    ];
    const dica = dicas[Math.floor(Math.random() * dicas.length)];
    alert(`ü§ñ ARIA: "${dica}"`);
  };
  
  document.getElementById('sync-btn').onclick = () => {
    alert("üîó Sincroniza√ß√£o completa! Dados compartilhados entre detetives. Algumas evid√™ncias podem ter sido atualizadas.");
  };
});
// =====================================
// SUSPEITOS E SOLU√á√ÉO
// =====================================
function mountSuspects() {
  const grid = document.getElementById('suspects-grid');
  if (!grid) return;
  
  grid.innerHTML = suspectsData.map(s => 
    `<div class="suspect-card">
      <h4>${s.emoji} ${s.nome}</h4>
      <b>${s.cargo}</b><br>
      <b>Motivo:</b> ${s.motivo}<br>
      <b>√Ålibi:</b> ${s.alibi}
    </div>`
  ).join('') + 
  `<button id="back-investigation" style="margin:20px 0;padding:12px 30px;background:#32e6ff;color:#032336;border:none;border-radius:8px;font-weight:bold;cursor:pointer;">
    ‚¨ÖÔ∏è Voltar √† Investiga√ß√£o
  </button>`;
  
  setTimeout(() => {
    const backBtn = document.getElementById('back-investigation');
    if (backBtn) {
      backBtn.onclick = () => showScreen('investigation');
    }
  }, 100);
}

function prepareSolutionScreen() {
  let killerSel = document.getElementById('killer-select');
  let accSel = document.getElementById('accomplice-select');
  
  if (killerSel && accSel) {
    const options = "<option value=''>Selecione</option>" + 
      suspectsData.map((s, i) => `<option value="${i}">${s.nome}</option>`).join('');
    killerSel.innerHTML = options;
    accSel.innerHTML = options;
  }
}

document.getElementById('submit-solution').onclick = () => {
  let killerIdx = document.getElementById('killer-select').value;
  let methodIdx = document.getElementById('method-select').selectedIndex;
  let accIdx = document.getElementById('accomplice-select').value;
  
  let msg = "";
  if ((killerIdx == 1) && (accIdx == 6) && (methodIdx == 1)) {
    msg = "‚úÖ Parab√©ns! Voc√™ desvendou o mist√©rio: Dr. Marcus Webb e Zara Al-Rashid eliminaram Elena usando Nanotecnologia Letal! A conspira√ß√£o foi exposta e Alpha-7 est√° segura.";
  } else if (killerIdx == 1) {
    msg = "üéØ Quase! Voc√™ acertou o assassino principal, mas errou alguns detalhes. A verdade est√° pr√≥xima...";
  } else {
    msg = "‚ùå Erro! O culpado real escapou durante a investiga√ß√£o. A conspira√ß√£o continua ativa em Alpha-7...";
  }
  
  alert(msg);
  showScreen('investigation');
};

// Inicializa√ß√£o
updateRecursosEFiltros();
